# vim: filetype=sh
# -*- sh -*-

##### ==== Shell behavior ====
# vi-mode editing
set -o vi

# Emacs-like convenience bindings
bind '"\C-a": beginning-of-line'
bind '"\C-e": end-of-line'
bind '"\C-r": reverse-search-history'

# zsh-like behavior in bash
shopt -s autocd     # type directory name to cd
shopt -s cdspell    # correct small typos in 'cd'

##### ==== Locale ====
export LANGUAGE=en_US:en
export LANG=en_US.UTF-8

##### ==== History settings ====
export HISTCONTROL=ignoredups:erasedups
shopt -s histappend
shopt -s cmdhist
shopt -s lithist
export HISTIGNORE="ls*:ll*:history*:pwd*:lv*:"
export HISTSIZE=1000000
export HISTFILESIZE=10000000
HISTTIMEFORMAT='%Y%m%d %T: '
export HISTTIMEFORMAT
export PROMPT_COMMAND="${PROMPT_COMMAND:+$PROMPT_COMMAND$'\n'}history -a; history -c; history -r"

##### ==== TTY tweaks ====
stty stop undef

##### ==== Aliases ====
alias ll='CLICOLOR_FORCE=1 ls -aGhl'
alias la='ls -A'
alias l='ls -CF'
alias less='less -R'
alias cp='cp -p'
alias mv='mv -i'      # ask before overwrite
alias rm='rm -i'      # ask before delete
alias diskspace="du -S | sort -n -r | more"
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias df='df -h'
alias du='du -h'

# pretty helpers
alias pretty_csv='~/.zsh/pretty_csv.sh'
alias pretty_tsv='~/.zsh/pretty_tsv.sh'

##### ==== Directory navigation helpers ====
alias md='mkdir -p'
alias rd='rmdir'

# Quick extraction function (very common)
extract () {
    if [ -f "$1" ] ; then
        case "$1" in
            *.tar.bz2)   tar xjf "$1"   ;;
            *.tar.gz)    tar xzf "$1"   ;;
            *.bz2)       bunzip2 "$1"   ;;
            *.rar)       unrar x "$1"   ;;
            *.gz)        gunzip "$1"    ;;
            *.tar)       tar xf "$1"    ;;
            *.tbz2)      tar xjf "$1"   ;;
            *.tgz)       tar xzf "$1"   ;;
            *.zip)       unzip "$1"     ;;
            *.7z)        7z x "$1"      ;;
            *.Z)         uncompress "$1";;
            *)           echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

##### ==== Raise open-file limit if needed (for rsync and other file-heavy jobs) ====
{{ if eq .chezmoi.os "linux" }}
if [ "$(ulimit -n)" -lt 65535 ]; then
  ulimit -n 65535 2>/dev/null || true
fi
{{ end }}

##### ==== Git completion & prompt ====
if [ -f /etc/bash_completion ]; then
  . /etc/bash_completion
elif [ -f /usr/share/bash-completion/bash_completion ]; then
  . /usr/share/bash-completion/bash_completion
fi

if [ -f ~/git-completion.bash ]; then
  . ~/git-completion.bash
fi

if [ -f /usr/share/git-core/contrib/completion/git-prompt.sh ]; then
  . /usr/share/git-core/contrib/completion/git-prompt.sh
elif [ -f /usr/share/git/completion/git-prompt.sh ]; then
  . /usr/share/git/completion/git-prompt.sh
elif [ -f ~/.zsh/.git-prompt.sh ]; then
  . ~/.zsh/.git-prompt.sh
fi

export GIT_PS1_SHOWDIRTYSTATE=true
export GIT_PS1_SHOWUNTRACKEDFILES=true
export GIT_PS1_SHOWSTASHSTATE=true
export GIT_PS1_SHOWUPSTREAM=auto

# Prompt (git-aware)
export PS1='\[\033[35m\]\u\[\033[31m\]@\h\[\033[00m\]:\[\033[33m\]\W\[\033[32m\]$(__git_ps1)\[\033[00m\]\$ '

##### ==== Git aliases ====
alias gs='git -c color.status=always status'
alias gc='git commit'
alias ga='git add'
alias gd='git -c color.ui=always diff'
alias gb='git branch'
alias gl='git -c color.ui=always log'
alias gsb='git show-branch'
alias gco='git checkout'
alias gg='git grep'
alias gk='gitk --all'
alias gr='git rebase'
alias gri='git rebase --interactive'
alias gcp='git cherry-pick'
alias grm='git rm'
alias gtree='git log --graph --pretty=oneline --abbrev-commit'

##### ==== Quality of life ====
# Colored man pages (if less supports it)
export LESS_TERMCAP_mb=$'\e[1;31m'
export LESS_TERMCAP_md=$'\e[1;36m'
export LESS_TERMCAP_me=$'\e[0m'
export LESS_TERMCAP_se=$'\e[0m'
export LESS_TERMCAP_so=$'\e[1;44;33m'
export LESS_TERMCAP_ue=$'\e[0m'
export LESS_TERMCAP_us=$'\e[1;32m'

# Safer PATH (user bin comes first)
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

